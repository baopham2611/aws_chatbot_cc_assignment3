<!-- Main content with chatbox and sidebar -->
<div class="container-fluid my-5">
  <div class="row">
    <!-- Sidebar for Conversation History -->
    <div class="col-md-2">
      <h5 class="mb-4">Conversation History</h5>
      
      <!-- History list -->
      <ul id="conversation-list" class="list-group mb-3" style="max-height: 600px; overflow-y: auto;">
        <!-- Conversation history items will appear here -->
      </ul>
      
      <!-- New Conversation Button -->
      <button class="btn btn-success mt-3" onclick="startNewConversation()">New Conversation</button>
    </div>

    <!-- Chatbox Area -->
    <div class="col-md-10">
      <h4 class="mb-4">Chatbox</h4>
      
      <!-- Chat box -->
      <div id="chat-box" class="border rounded p-4 mb-4 shadow-sm" style="height: 600px; overflow-y: scroll; background-color: #f1f1f1;">
        <!-- Chat messages will appear here -->
      </div>

      <!-- User input area -->
      <div class="input-group">
        <input type="text" id="user-input" class="form-control" placeholder="Type your message...">
        <div class="input-group-append">
          <button class="btn btn-primary" type="button" onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let conversationHistory = [];  // Array to hold the current conversation history
  let conversationId = null;     // This will hold the current conversation ID

  // Fetch conversation history and populate the list
  async function loadConversationHistory() {
    try {
      const response = await fetch('/api/conversations', { method: 'GET' });
      
      if (!response.ok) {
        throw new Error(`Failed to fetch conversations. Status: ${response.status}`);
      }
  
      const data = await response.json();
      console.log("Conversations fetched from backend:", data);
  
      const conversationList = document.getElementById('conversation-list');
      conversationList.innerHTML = '';  // Clear the current list
  
      if (data.conversations && data.conversations.length > 0) {
        // Populate the conversation list with existing conversations
        data.conversations.forEach((conversation) => {
          const listItem = document.createElement('li');
          listItem.className = 'list-group-item';
          listItem.innerHTML = ` ${conversation.message} ${conversation.timestamp}`;
          listItem.onclick = () => {
            console.log("Clicked conversation_id:", conversation.conversation_id);  // Print the conversation_id
            loadConversation(conversation.conversation_id);  // Load conversation on click
          };
          conversationList.appendChild(listItem);
        });
      } else {
        conversationList.innerHTML = '<li class="list-group-item">No conversations found.</li>';
      }
    } catch (error) {
      console.error('Error loading conversation history:', error);
    }
  }
  
  // Start a new conversation
  async function startNewConversation() {
    try {
      // Clear chat and history
      document.getElementById('chat-box').innerHTML = '';
      conversationHistory = [];  // Clear current conversation history

      // Initialize a new conversation by calling the backend
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: 'start new conversation' }),
      });

      const data = await response.json();

      // Set the new conversation ID
      conversationId = data.conversation_id;

      // Store the system message in the chat
      const systemMessage = "New conversation started.";
      document.getElementById('chat-box').innerHTML += `<p><strong>System:</strong> ${systemMessage}</p>`;
      conversationHistory.push({ sender: 'System', message: systemMessage });

      // Reload the conversation list after starting a new one
      loadConversationHistory();
    } catch (error) {
      console.error('Error starting new conversation:', error);
    }
  }

  // Helper function to truncate the message
  function truncateMessage(message, maxLength = 30) {
    if (message.length > maxLength) {
      return message.substring(0, maxLength) + '...';
    }
    return message;
  }

  // Helper function to format the timestamp as dd/mm/yyyy hh:mm
  function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${day}/${month}/${year} ${hours}:${minutes}`;
  }

  // Fetch conversation history and populate the list
  async function loadConversationHistory() {
    try {
      const response = await fetch('/api/conversations', { method: 'GET' });
      
      if (!response.ok) {
        throw new Error(`Failed to fetch conversations. Status: ${response.status}`);
      }

      const data = await response.json();
      console.log("Conversations fetched from backend:", data);

      const conversationList = document.getElementById('conversation-list');
      conversationList.innerHTML = '';  // Clear the current list

      if (data.conversations && data.conversations.length > 0) {
        // Populate the conversation list with existing conversations
        data.conversations.forEach((conversation) => {
          const listItem = document.createElement('li');
          listItem.className = 'list-group-item';
          
          // Truncate the message and format the timestamp
          const truncatedMessage = truncateMessage(conversation.message, 30);
          const formattedTimestamp = formatTimestamp(conversation.timestamp);

          listItem.innerHTML = `
            <div>
              <span>${truncatedMessage}</span>
              <br>
              <span style="font-size: 12px; color: gray;">${formattedTimestamp}</span>
            </div>
          `;

          listItem.onclick = () => {
            console.log("Clicked conversation_id:", conversation.conversation_id);  // Print the conversation_id
            loadConversation(conversation.conversation_id);  // Load conversation on click
          };

          conversationList.appendChild(listItem);
        });
      } else {
        conversationList.innerHTML = '<li class="list-group-item">No conversations found.</li>';
      }
    } catch (error) {
      console.error('Error loading conversation history:', error);
    }
  }
// Load a specific conversation and display its messages
async function loadConversation(conversation_id) {
  try {
      conversationId = conversation_id;  // Set the current conversation ID

      // Fetch the conversation messages from the backend
      const response = await fetch(`/api/conversations/${conversation_id}`, { method: 'GET' });

      if (!response.ok) {
          throw new Error(`Error fetching conversation ${conversation_id}: ${response.status}`);
      }

      const data = await response.json();

      // Clear the chat box and load the conversation history
      const chatBox = document.getElementById('chat-box');
      chatBox.innerHTML = '';  // Clear previous messages

      if (data.messages && data.messages.length > 0) {
          // Display each message in the chat box
          data.messages.forEach((entry) => {
              const safeMessage = entry.message || 'No message'; // Ensure message exists
              const formattedMessage = safeMessage.replace(/\n/g, '<br>');  // Replace newlines with <br>
              chatBox.innerHTML += `<p><strong>${entry.sender}:</strong> ${formattedMessage}</p>`;
          });

          // Scroll to the bottom of the chat box
          chatBox.scrollTop = chatBox.scrollHeight;
      } else {
          chatBox.innerHTML = '<p>No messages found for this conversation.</p>';
      }
  } catch (error) {
      console.error('Error loading conversation:', error);
  }
}


// Send a message to the chatbot
async function sendMessage() {
  try {
      const userMessage = document.getElementById('user-input').value;

      if (!userMessage.trim()) return;  // Don't send empty messages

      // Add user message to the chat box
      document.getElementById('chat-box').innerHTML += `<p><strong>You:</strong> ${userMessage}</p>`;
      document.getElementById('user-input').value = '';

      // Send message to the backend API and pass the conversation ID
      const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: userMessage, conversation_id: conversationId }),
      });

      const data = await response.json();

      // Replace newlines in the bot's response with <br> for proper HTML formatting
      const formattedResponse = data.answer.replace(/\n/g, '<br>');

      // Display bot response in the chat box
      document.getElementById('chat-box').innerHTML += `<p><strong>Bot:</strong> ${formattedResponse}</p>`;

      // Update conversation history
      conversationHistory.push({ sender: 'You', message: userMessage });
      conversationHistory.push({ sender: 'Bot', message: formattedResponse });

      // Scroll chat box to the bottom after the new message
      document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
  } catch (error) {
      console.error('Error sending message:', error);
  }
}


  // Load the conversation history when the page loads
  window.onload = loadConversationHistory;
</script>
